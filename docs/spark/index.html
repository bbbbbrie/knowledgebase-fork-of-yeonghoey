<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Apache Spark</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">Apache Spark</h1>
</header>
<h1 id="table-of-contents">Table of Contents <span class="tag" data-tag-name="TOC_3_gh"><span class="smallcaps">TOC_3_gh</span></span></h1>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#reference">Reference</a>
<ul>
<li><a href="#spark-api">Spark API</a>
<ul>
<li><a href="#file-input-pattern">File Input pattern</a></li>
</ul></li>
<li><a href="#spark-sql">Spark SQL</a>
<ul>
<li><a href="#reference-links">Reference Links</a></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#recipes">Recipes</a></li>
<li><a href="#example-codes">Example codes</a></li>
</ul></li>
</ul></li>
<li><a href="#terminology">Terminology</a></li>
<li><a href="#topics">Topics</a>
<ul>
<li><a href="#how-schema-merging-works">How schema merging works</a></li>
</ul></li>
<li><a href="#how-to">How-to</a></li>
<li><a href="#links">Links</a></li>
</ul>
<h1 id="overview">Overview</h1>
<h1 id="reference">Reference</h1>
<h2 id="spark-api">Spark API</h2>
<h3 id="file-input-pattern">File Input pattern</h3>
<p><a href="http://stackoverflow.com/questions/31782763/how-to-use-regex-to-include-exclude-some-input-files-in-sc-textfile" class="uri">http://stackoverflow.com/questions/31782763/how-to-use-regex-to-include-exclude-some-input-files-in-sc-textfile</a></p>
<ul>
<li><code>*</code> (match 0 or more character)</li>
<li><code>?</code> (match single character)</li>
<li><code>[ab]</code> (character class)</li>
<li><code>[^ab]</code> (negated character class)</li>
<li><code>[a-b]</code> (character range)</li>
<li><code>{a,b}</code> (alternation)</li>
<li><code>\c</code> (escape character)</li>
</ul>
<p>You can use commas as delimiters of multiple patterns:</p>
<pre class="example"><code>sc.textFile(&quot;/user/Orders/2015072[7-9]*,/user/Orders/2015073[0-1]*&quot;)
</code></pre>
<p>Which is same as:</p>
<pre class="example"><code>sc.textFile(&quot;/user/Orders/201507{2[7-9],3[0-1]}*&quot;)
</code></pre>
<h2 id="spark-sql">Spark SQL</h2>
<h3 id="reference-links">Reference Links</h3>
<p>There seems to be a newly documented page: <a href="https://docs.databricks.com/spark/latest/spark-sql/index.html" class="uri">https://docs.databricks.com/spark/latest/spark-sql/index.html</a></p>
<p>Spark SQL's query languages is based on <code>HiveQL</code>.</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select" class="uri">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF" class="uri">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF</a></li>
<li><a href="http://spark.apache.org/docs/latest/sql-programming-guide.html#supported-hive-features" class="uri">http://spark.apache.org/docs/latest/sql-programming-guide.html#supported-hive-features</a></li>
</ul>
<h3 id="examples">Examples</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- basics</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">select</span> col1 <span class="kw">from</span> t1 <span class="kw">where</span> col1 &gt; <span class="dv">10</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">select</span> * <span class="kw">from</span> t1 <span class="kw">limit</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">-- plan</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">explain</span> <span class="kw">select</span> * <span class="kw">from</span> t1</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">-- group by</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">select</span> col1, <span class="fu">count</span>(*) <span class="kw">from</span> t1 <span class="kw">group</span> <span class="kw">by</span> col1</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">select</span> col1, <span class="fu">sum</span>(col2) <span class="kw">from</span> t1 <span class="kw">group</span> <span class="kw">by</span> col1</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">-- &#39;group by&#39; can be specified with position numbers(1-indexed from selected columns)</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">select</span> col1, <span class="fu">sum</span>(col2) <span class="kw">from</span> t1 <span class="kw">group</span> <span class="kw">by</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">-- distinct</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="kw">select</span> col1, col2 <span class="kw">from</span> t1</a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="dv">1</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="dv">1</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="dv">1</span> <span class="dv">4</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="dv">2</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="kw">select</span> <span class="kw">distinct</span> col1, col2 <span class="kw">from</span> t1</a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="dv">1</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="dv">1</span> <span class="dv">4</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="dv">2</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="kw">select</span> <span class="kw">distinct</span> col1 <span class="kw">from</span> t1</a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29"><span class="dv">2</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"></a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="co">-- distinct can be used within &#39;count&#39;</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="kw">select</span> col1, <span class="fu">count</span>(<span class="kw">distinct</span> col2) <span class="kw">from</span> t1 <span class="kw">group</span> <span class="kw">by</span> col1</a>
<a class="sourceLine" id="cb3-33" data-line-number="33"></a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="co">-- having</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="kw">select</span> col1 <span class="kw">from</span> t1 <span class="kw">group</span> <span class="kw">by</span> col1 <span class="kw">having</span> <span class="fu">sum</span>(col2) &gt; <span class="dv">10</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36"><span class="co">-- same as above</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"><span class="kw">select</span> col1 <span class="kw">from</span> (<span class="kw">select</span> col1, <span class="fu">sum</span>(col2) <span class="kw">as</span> col2sum <span class="kw">from</span> t1 <span class="kw">group</span> <span class="kw">by</span> col1) t2 <span class="kw">where</span> t2.col2sum &gt; <span class="dv">10</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"></a>
<a class="sourceLine" id="cb3-39" data-line-number="39"><span class="co">-- order by</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40"><span class="kw">select</span> col1 <span class="kw">from</span> t1 <span class="kw">order</span> <span class="kw">by</span> col1 <span class="kw">desc</span></a>
<a class="sourceLine" id="cb3-41" data-line-number="41"></a>
<a class="sourceLine" id="cb3-42" data-line-number="42"><span class="co">-- join</span></a>
<a class="sourceLine" id="cb3-43" data-line-number="43"><span class="kw">select</span> a.* <span class="kw">from</span> a <span class="kw">join</span> b <span class="kw">on</span> (a.id = b.id <span class="kw">and</span> a.department = b.department)</a>
<a class="sourceLine" id="cb3-44" data-line-number="44"><span class="kw">select</span> a.* <span class="kw">from</span> a <span class="kw">left</span> <span class="kw">outer</span> <span class="kw">join</span> b <span class="kw">on</span> (a.id &lt;&gt; b.id)</a>
<a class="sourceLine" id="cb3-45" data-line-number="45"><span class="kw">select</span> a.val, b.val, c.val <span class="kw">from</span> a <span class="kw">join</span> b <span class="kw">on</span> (a.key = b.key1) <span class="kw">join</span> c <span class="kw">on</span> (c.key = b.key1)</a>
<a class="sourceLine" id="cb3-46" data-line-number="46"></a>
<a class="sourceLine" id="cb3-47" data-line-number="47"><span class="co">-- joins occur before where clauses, this is a bad way:</span></a>
<a class="sourceLine" id="cb3-48" data-line-number="48"><span class="kw">select</span> a.val, b.val <span class="kw">from</span> a <span class="kw">left</span> <span class="kw">outer</span> <span class="kw">join</span> b <span class="kw">on</span> (a.key=b.key)</a>
<a class="sourceLine" id="cb3-49" data-line-number="49"><span class="kw">where</span> a.ds=<span class="st">&#39;2009-07-07&#39;</span> <span class="kw">and</span> b.ds=<span class="st">&#39;2009-07-07&#39;</span></a>
<a class="sourceLine" id="cb3-50" data-line-number="50"></a>
<a class="sourceLine" id="cb3-51" data-line-number="51"><span class="co">-- following is better:</span></a>
<a class="sourceLine" id="cb3-52" data-line-number="52"><span class="kw">select</span> a.val, b.val <span class="kw">from</span> a <span class="kw">left</span> <span class="kw">outer</span> <span class="kw">join</span> b</a>
<a class="sourceLine" id="cb3-53" data-line-number="53"><span class="kw">on</span> (a.key=b.key <span class="kw">and</span> b.ds=<span class="st">&#39;2009-07-07&#39;</span> <span class="kw">and</span> a.ds=<span class="st">&#39;2009-07-07&#39;</span>)</a>
<a class="sourceLine" id="cb3-54" data-line-number="54"></a>
<a class="sourceLine" id="cb3-55" data-line-number="55"><span class="co">-- union</span></a>
<a class="sourceLine" id="cb3-56" data-line-number="56"><span class="kw">select</span> u.id, actions.date</a>
<a class="sourceLine" id="cb3-57" data-line-number="57"><span class="kw">from</span> (</a>
<a class="sourceLine" id="cb3-58" data-line-number="58">  <span class="kw">select</span> av.uid <span class="kw">as</span> <span class="fu">uid</span></a>
<a class="sourceLine" id="cb3-59" data-line-number="59">  <span class="kw">from</span> action_video av</a>
<a class="sourceLine" id="cb3-60" data-line-number="60">  <span class="kw">where</span> av.date = <span class="st">&#39;2008-06-03&#39;</span></a>
<a class="sourceLine" id="cb3-61" data-line-number="61">  <span class="kw">union</span> <span class="kw">all</span></a>
<a class="sourceLine" id="cb3-62" data-line-number="62">  <span class="kw">select</span> ac.uid <span class="kw">as</span> <span class="fu">uid</span></a>
<a class="sourceLine" id="cb3-63" data-line-number="63">  <span class="kw">from</span> action_comment ac</a>
<a class="sourceLine" id="cb3-64" data-line-number="64">  <span class="kw">where</span> ac.date = <span class="st">&#39;2008-06-03&#39;</span></a>
<a class="sourceLine" id="cb3-65" data-line-number="65">) actions <span class="kw">join</span> users u <span class="kw">on</span> (u.id = actions.uid)</a>
<a class="sourceLine" id="cb3-66" data-line-number="66"></a>
<a class="sourceLine" id="cb3-67" data-line-number="67"><span class="co">-- if, case</span></a>
<a class="sourceLine" id="cb3-68" data-line-number="68"><span class="kw">select</span> <span class="kw">if</span>(field <span class="kw">in</span> (<span class="dv">0</span>, <span class="dv">1</span>), <span class="st">&#39;ab&#39;</span>, <span class="st">&#39;c&#39;</span>) <span class="kw">from</span> tbl</a>
<a class="sourceLine" id="cb3-69" data-line-number="69"></a>
<a class="sourceLine" id="cb3-70" data-line-number="70"><span class="kw">select</span></a>
<a class="sourceLine" id="cb3-71" data-line-number="71">  <span class="kw">case</span> field</a>
<a class="sourceLine" id="cb3-72" data-line-number="72">  <span class="kw">when</span> <span class="dv">0</span> <span class="kw">then</span> <span class="st">&#39;a&#39;</span></a>
<a class="sourceLine" id="cb3-73" data-line-number="73">  <span class="kw">when</span> <span class="dv">1</span> <span class="kw">then</span> <span class="st">&#39;b&#39;</span></a>
<a class="sourceLine" id="cb3-74" data-line-number="74">  <span class="kw">else</span> <span class="st">&#39;c&#39;</span></a>
<a class="sourceLine" id="cb3-75" data-line-number="75">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb3-76" data-line-number="76"><span class="kw">from</span> tbl</a>
<a class="sourceLine" id="cb3-77" data-line-number="77"></a>
<a class="sourceLine" id="cb3-78" data-line-number="78"><span class="co">-- subqueries</span></a>
<a class="sourceLine" id="cb3-79" data-line-number="79"><span class="kw">select</span> col</a>
<a class="sourceLine" id="cb3-80" data-line-number="80"><span class="kw">from</span> (</a>
<a class="sourceLine" id="cb3-81" data-line-number="81">  <span class="kw">select</span> a+b <span class="kw">as</span> col</a>
<a class="sourceLine" id="cb3-82" data-line-number="82">  <span class="kw">from</span> t1</a>
<a class="sourceLine" id="cb3-83" data-line-number="83">) t2</a>
<a class="sourceLine" id="cb3-84" data-line-number="84"></a>
<a class="sourceLine" id="cb3-85" data-line-number="85"><span class="kw">select</span> *</a>
<a class="sourceLine" id="cb3-86" data-line-number="86"><span class="kw">from</span> a</a>
<a class="sourceLine" id="cb3-87" data-line-number="87"><span class="kw">where</span> a.a <span class="kw">in</span> (<span class="kw">select</span> foo <span class="kw">from</span> b);</a>
<a class="sourceLine" id="cb3-88" data-line-number="88"></a>
<a class="sourceLine" id="cb3-89" data-line-number="89"><span class="kw">select</span> a</a>
<a class="sourceLine" id="cb3-90" data-line-number="90"><span class="kw">from</span> t1</a>
<a class="sourceLine" id="cb3-91" data-line-number="91"><span class="kw">where</span> <span class="kw">exists</span> (<span class="kw">select</span> b <span class="kw">from</span> t2 <span class="kw">where</span> t1.x = t2.y)</a>
<a class="sourceLine" id="cb3-92" data-line-number="92"></a>
<a class="sourceLine" id="cb3-93" data-line-number="93"><span class="co">-- common table expression</span></a>
<a class="sourceLine" id="cb3-94" data-line-number="94"><span class="kw">with</span> q1 <span class="kw">as</span> (<span class="kw">select</span> <span class="kw">key</span> <span class="kw">from</span> src <span class="kw">where</span> <span class="kw">key</span> = <span class="st">&#39;5&#39;</span>)</a>
<a class="sourceLine" id="cb3-95" data-line-number="95"><span class="kw">select</span> *</a>
<a class="sourceLine" id="cb3-96" data-line-number="96"><span class="kw">from</span> q1;</a>
<a class="sourceLine" id="cb3-97" data-line-number="97"></a>
<a class="sourceLine" id="cb3-98" data-line-number="98"><span class="kw">with</span> q1 <span class="kw">as</span> (<span class="kw">select</span> * <span class="kw">from</span> src <span class="kw">where</span> key= <span class="st">&#39;5&#39;</span>),</a>
<a class="sourceLine" id="cb3-99" data-line-number="99">     q2 <span class="kw">as</span> (<span class="kw">select</span> * <span class="kw">from</span> src s2 <span class="kw">where</span> <span class="kw">key</span> = <span class="st">&#39;4&#39;</span>)</a>
<a class="sourceLine" id="cb3-100" data-line-number="100"><span class="kw">select</span> * <span class="kw">from</span> q1 <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> * <span class="kw">from</span> q2;</a>
<a class="sourceLine" id="cb3-101" data-line-number="101"></a>
<a class="sourceLine" id="cb3-102" data-line-number="102"><span class="co">-- create table as select example</span></a>
<a class="sourceLine" id="cb3-103" data-line-number="103"><span class="kw">create</span> <span class="kw">table</span> s2 <span class="kw">as</span></a>
<a class="sourceLine" id="cb3-104" data-line-number="104"><span class="kw">with</span> q1 <span class="kw">as</span> ( <span class="kw">select</span> <span class="kw">key</span> <span class="kw">from</span> src <span class="kw">where</span> <span class="kw">key</span> = <span class="st">&#39;4&#39;</span>)</a>
<a class="sourceLine" id="cb3-105" data-line-number="105"><span class="kw">select</span> * <span class="kw">from</span> q1;</a>
<a class="sourceLine" id="cb3-106" data-line-number="106"></a>
<a class="sourceLine" id="cb3-107" data-line-number="107"><span class="co">-- create or replace temporary view is recommended instead of just &#39;create table&#39;</span></a>
<a class="sourceLine" id="cb3-108" data-line-number="108"><span class="kw">create</span> <span class="kw">or</span> <span class="kw">replace</span> <span class="kw">temporary</span> <span class="kw">view</span> foo <span class="kw">as</span> <span class="kw">select</span> * <span class="kw">from</span> t1 <span class="kw">limit</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-109" data-line-number="109"></a>
<a class="sourceLine" id="cb3-110" data-line-number="110"><span class="co">-- view example</span></a>
<a class="sourceLine" id="cb3-111" data-line-number="111"><span class="kw">create</span> <span class="kw">view</span> v1 <span class="kw">as</span></a>
<a class="sourceLine" id="cb3-112" data-line-number="112"><span class="kw">with</span> q1 <span class="kw">as</span> ( <span class="kw">select</span> <span class="kw">key</span> <span class="kw">from</span> src <span class="kw">where</span> <span class="kw">key</span> = <span class="st">&#39;5&#39;</span>)</a>
<a class="sourceLine" id="cb3-113" data-line-number="113"><span class="kw">select</span> * <span class="kw">from</span> q1;</a>
<a class="sourceLine" id="cb3-114" data-line-number="114"></a>
<a class="sourceLine" id="cb3-115" data-line-number="115"><span class="co">-- lateral view</span></a>
<a class="sourceLine" id="cb3-116" data-line-number="116"><span class="kw">select</span> adid, <span class="fu">count</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-117" data-line-number="117"><span class="kw">from</span> pageads lateral <span class="kw">view</span> explode(adid_list) adtable <span class="kw">as</span> adid</a>
<a class="sourceLine" id="cb3-118" data-line-number="118"><span class="kw">group</span> <span class="kw">by</span> adid</a>
<a class="sourceLine" id="cb3-119" data-line-number="119"></a>
<a class="sourceLine" id="cb3-120" data-line-number="120"><span class="kw">select</span> k, v</a>
<a class="sourceLine" id="cb3-121" data-line-number="121"><span class="kw">from</span> tbl lateral <span class="kw">view</span> explode(kvmap) kvs <span class="kw">as</span> k, v</a>
<a class="sourceLine" id="cb3-122" data-line-number="122"><span class="kw">group</span> <span class="kw">by</span> k</a>
<a class="sourceLine" id="cb3-123" data-line-number="123"></a>
<a class="sourceLine" id="cb3-124" data-line-number="124"><span class="kw">select</span> mycol1, mycol2 <span class="kw">from</span> basetable</a>
<a class="sourceLine" id="cb3-125" data-line-number="125">lateral <span class="kw">view</span> explode(col1) mytable1 <span class="kw">as</span> mycol1</a>
<a class="sourceLine" id="cb3-126" data-line-number="126">lateral <span class="kw">view</span> explode(col2) mytable2 <span class="kw">as</span> mycol2;</a>
<a class="sourceLine" id="cb3-127" data-line-number="127"></a>
<a class="sourceLine" id="cb3-128" data-line-number="128"><span class="kw">select</span> * <span class="kw">from</span> src lateral <span class="kw">view</span> <span class="kw">outer</span> explode(<span class="dt">array</span>()) c <span class="kw">as</span> a <span class="kw">limit</span> <span class="dv">10</span>;</a>
<a class="sourceLine" id="cb3-129" data-line-number="129"></a>
<a class="sourceLine" id="cb3-130" data-line-number="130"><span class="co">-- time range (t is of timestamp type)</span></a>
<a class="sourceLine" id="cb3-131" data-line-number="131"><span class="kw">select</span> t <span class="kw">from</span> table1</a>
<a class="sourceLine" id="cb3-132" data-line-number="132"><span class="kw">where</span> t &gt; to_utc_timestamp(<span class="ot">&quot;2016-12-25&quot;</span>, <span class="ot">&quot;UTC&quot;</span>)</a>
<a class="sourceLine" id="cb3-133" data-line-number="133"><span class="kw">and</span> t &lt; to_utc_timestamp(<span class="ot">&quot;2016-12-25 12:00&quot;</span>, <span class="ot">&quot;UTC&quot;</span>)</a>
<a class="sourceLine" id="cb3-134" data-line-number="134"></a>
<a class="sourceLine" id="cb3-135" data-line-number="135"><span class="co">-- timestamp to string</span></a>
<a class="sourceLine" id="cb3-136" data-line-number="136"><span class="kw">select</span> date_format(t, <span class="st">&#39;YYYY-MM-dd&#39;</span>) <span class="kw">from</span> tbl</a>
<a class="sourceLine" id="cb3-137" data-line-number="137"></a>
<a class="sourceLine" id="cb3-138" data-line-number="138"><span class="co">-- select field with special characters(use backtick)</span></a>
<a class="sourceLine" id="cb3-139" data-line-number="139"><span class="kw">select</span> `@time` <span class="kw">from</span> t1</a>
<a class="sourceLine" id="cb3-140" data-line-number="140"></a>
<a class="sourceLine" id="cb3-141" data-line-number="141"><span class="co">-- concat_ws to make an array as a string</span></a>
<a class="sourceLine" id="cb3-142" data-line-number="142"><span class="co">-- map_values to make a map as an array</span></a>
<a class="sourceLine" id="cb3-143" data-line-number="143"><span class="co">-- &lt;array of structtype&gt;.&lt;field&gt; goes into an &lt;array of field&gt;</span></a>
<a class="sourceLine" id="cb3-144" data-line-number="144"><span class="kw">select</span> concat_ws(<span class="ot">&quot;, &quot;</span>, map_values(items).price)</a>
<a class="sourceLine" id="cb3-145" data-line-number="145"><span class="kw">from</span> Items</a></code></pre></div>
<h3 id="recipes">Recipes</h3>
<ol>
<li><p>Referencing query results as <code>DataFrame</code> in spark application</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb4-1" data-line-number="1">%sql</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">create</span> <span class="kw">or</span> <span class="kw">replace</span> <span class="kw">temporary</span> <span class="kw">view</span> foo <span class="kw">as</span> <span class="kw">select</span> * <span class="kw">from</span> t1 <span class="kw">limit</span> <span class="dv">1</span></a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">val</span> spark: SparkSession = ...</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">val</span> df = spark.<span class="fu">table</span>(<span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">// work with df</span></a></code></pre></div></li>
</ol>
<h3 id="example-codes">Example codes</h3>
<p><a href="https://github.com/apache/spark/tree/master/examples/src/main/scala/org/apache/spark/examples/sql" class="uri">https://github.com/apache/spark/tree/master/examples/src/main/scala/org/apache/spark/examples/sql</a></p>
<h1 id="terminology">Terminology</h1>
<h1 id="topics">Topics</h1>
<h2 id="how-schema-merging-works">How schema merging works</h2>
<ul>
<li><a href="https://spark.apache.org/docs/latest/sql-programming-guide.html#schema-merging" class="uri">https://spark.apache.org/docs/latest/sql-programming-guide.html#schema-merging</a></li>
</ul>
<p>There were no clear documentation about how the merging schema across files works. There are only some the general guidelines of growing schema: Append only, no modification.</p>
<p>But I was curious that if appending is OK, can I just reorder the <code>StructFields</code>? Because <code>StructType</code> takes them as a <code>List</code>, it may. But as the data source can be <code>json</code>, which doesn't care the order of fields, it may not. So I tested.</p>
<p>The conclusion is following:</p>
<ul>
<li>The order of <code>StructField</code> doesn't matter. <strong>Only field name matters.</strong></li>
<li>If <code>mergeSchema</code> is <code>true</code>, all fields are merged.</li>
<li>If <code>mergeSchema</code> is <code>false</code>, which is default, The schema of the first file in alphabetical order has priority</li>
<li>The <code>nullable</code> in <code>StructType</code> doesn't matter. It seem to only matter when processing raw data, but merging files.</li>
<li><strong>If there are fields with the same name and different types, schema merging will cause runtime errors.</strong></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">Row</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">types</span>._</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw">import</span> spark.<span class="fu">implicits</span>._</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw">def</span> <span class="fu">createSchema</span>(schema: String): StructType = {</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    <span class="kw">val</span> fieldNames = schema.<span class="fu">split</span>(<span class="st">&quot; &quot;</span>)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    <span class="kw">val</span> fields = fieldNames.<span class="fu">map</span> { name =&gt;</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">        <span class="fu">StructField</span>(name, StringType)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    }</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    <span class="fu">StructType</span>(fields)</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb6-12" data-line-number="12"></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="co">// A schema of &#39;name&#39; and &#39;addr&#39;</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="kw">val</span> schema1 = <span class="fu">createSchema</span>(<span class="st">&quot;name addr&quot;</span>)</a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="kw">val</span> data1   = List(<span class="fu">Row</span>(<span class="st">&quot;yeonghoey&quot;</span>, <span class="st">&quot;jamsil&quot;</span>))</a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="kw">val</span> rdd1    = spark.<span class="fu">sparkContext</span>.<span class="fu">parallelize</span>(data1)</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="kw">val</span> df1     = spark.<span class="fu">createDataFrame</span>(rdd1, schema1)</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">df1.<span class="fu">write</span>.<span class="fu">mode</span>(<span class="st">&quot;overwrite&quot;</span>).<span class="fu">parquet</span>(<span class="st">&quot;data1&quot;</span>)</a>
<a class="sourceLine" id="cb6-19" data-line-number="19"></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="co">// Add &#39;sex&#39; field in between the fields of schema1.</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="kw">val</span> schema2 = <span class="fu">createSchema</span>(<span class="st">&quot;name sex addr&quot;</span>)</a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="kw">val</span> data2   = List(<span class="fu">Row</span>(<span class="st">&quot;cwkim&quot;</span>, <span class="st">&quot;male&quot;</span>, <span class="st">&quot;unjung&quot;</span>))</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="kw">val</span> rdd2    = spark.<span class="fu">sparkContext</span>.<span class="fu">parallelize</span>(data2)</a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="kw">val</span> df2     = spark.<span class="fu">createDataFrame</span>(rdd2, schema2)</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">df2.<span class="fu">write</span>.<span class="fu">mode</span>(<span class="st">&quot;overwrite&quot;</span>).<span class="fu">parquet</span>(<span class="st">&quot;data2&quot;</span>)</a>
<a class="sourceLine" id="cb6-26" data-line-number="26"></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="co">// Append &#39;sex&#39; field to the schema1.</span></a>
<a class="sourceLine" id="cb6-28" data-line-number="28"><span class="kw">val</span> schema3 = <span class="fu">createSchema</span>(<span class="st">&quot;name addr sex&quot;</span>)</a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="kw">val</span> data3   = List(<span class="fu">Row</span>(<span class="st">&quot;sub&quot;</span>, <span class="st">&quot;yangjae&quot;</span>, <span class="st">&quot;male&quot;</span>))</a>
<a class="sourceLine" id="cb6-30" data-line-number="30"><span class="kw">val</span> rdd3    = spark.<span class="fu">sparkContext</span>.<span class="fu">parallelize</span>(data3)</a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="kw">val</span> df3     = spark.<span class="fu">createDataFrame</span>(rdd3, schema3)</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">df3.<span class="fu">write</span>.<span class="fu">mode</span>(<span class="st">&quot;overwrite&quot;</span>).<span class="fu">parquet</span>(<span class="st">&quot;data3&quot;</span>)</a>
<a class="sourceLine" id="cb6-33" data-line-number="33"></a>
<a class="sourceLine" id="cb6-34" data-line-number="34"><span class="co">// A schema of &#39;name&#39; and &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="kw">val</span> schema4 = <span class="fu">createSchema</span>(<span class="st">&quot;name sex&quot;</span>)</a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="kw">val</span> data4   = List(<span class="fu">Row</span>(<span class="st">&quot;suminb&quot;</span>, <span class="st">&quot;male&quot;</span>))</a>
<a class="sourceLine" id="cb6-37" data-line-number="37"><span class="kw">val</span> rdd4    = spark.<span class="fu">sparkContext</span>.<span class="fu">parallelize</span>(data4)</a>
<a class="sourceLine" id="cb6-38" data-line-number="38"><span class="kw">val</span> df4     = spark.<span class="fu">createDataFrame</span>(rdd4, schema4)</a>
<a class="sourceLine" id="cb6-39" data-line-number="39">df4.<span class="fu">write</span>.<span class="fu">mode</span>(<span class="st">&quot;overwrite&quot;</span>).<span class="fu">parquet</span>(<span class="st">&quot;data4&quot;</span>)</a>
<a class="sourceLine" id="cb6-40" data-line-number="40"></a>
<a class="sourceLine" id="cb6-41" data-line-number="41"><span class="co">// ----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb6-42" data-line-number="42"></a>
<a class="sourceLine" id="cb6-43" data-line-number="43"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-44" data-line-number="44"><span class="co">// + name sex addr</span></a>
<a class="sourceLine" id="cb6-45" data-line-number="45">spark.<span class="fu">read</span>.<span class="fu">parquet</span>(<span class="st">&quot;data{1,2}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-46" data-line-number="46"><span class="co">// +---------+------+</span></a>
<a class="sourceLine" id="cb6-47" data-line-number="47"><span class="co">// |     name|  addr|</span></a>
<a class="sourceLine" id="cb6-48" data-line-number="48"><span class="co">// +---------+------+</span></a>
<a class="sourceLine" id="cb6-49" data-line-number="49"><span class="co">// |    cwkim|unjung|</span></a>
<a class="sourceLine" id="cb6-50" data-line-number="50"><span class="co">// |yeonghoey|jamsil|</span></a>
<a class="sourceLine" id="cb6-51" data-line-number="51"><span class="co">// +---------+------+</span></a>
<a class="sourceLine" id="cb6-52" data-line-number="52"></a>
<a class="sourceLine" id="cb6-53" data-line-number="53"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-54" data-line-number="54"><span class="co">// * name sex addr</span></a>
<a class="sourceLine" id="cb6-55" data-line-number="55">spark.<span class="fu">read</span>.<span class="fu">option</span>(<span class="st">&quot;mergeSchema&quot;</span>, <span class="kw">true</span>).<span class="fu">parquet</span>(<span class="st">&quot;data{1,2}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-56" data-line-number="56"><span class="co">// +---------+------+----+</span></a>
<a class="sourceLine" id="cb6-57" data-line-number="57"><span class="co">// |     name|  addr| sex|</span></a>
<a class="sourceLine" id="cb6-58" data-line-number="58"><span class="co">// +---------+------+----+</span></a>
<a class="sourceLine" id="cb6-59" data-line-number="59"><span class="co">// |    cwkim|unjung|male|</span></a>
<a class="sourceLine" id="cb6-60" data-line-number="60"><span class="co">// |yeonghoey|jamsil|null|</span></a>
<a class="sourceLine" id="cb6-61" data-line-number="61"><span class="co">// +---------+------+----+</span></a>
<a class="sourceLine" id="cb6-62" data-line-number="62"></a>
<a class="sourceLine" id="cb6-63" data-line-number="63"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-64" data-line-number="64"><span class="co">// + name addr sex</span></a>
<a class="sourceLine" id="cb6-65" data-line-number="65">spark.<span class="fu">read</span>.<span class="fu">parquet</span>(<span class="st">&quot;data{1,3}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-66" data-line-number="66"><span class="co">// +---------+-------+</span></a>
<a class="sourceLine" id="cb6-67" data-line-number="67"><span class="co">// |     name|   addr|</span></a>
<a class="sourceLine" id="cb6-68" data-line-number="68"><span class="co">// +---------+-------+</span></a>
<a class="sourceLine" id="cb6-69" data-line-number="69"><span class="co">// |      sub|yangjae|</span></a>
<a class="sourceLine" id="cb6-70" data-line-number="70"><span class="co">// |yeonghoey| jamsil|</span></a>
<a class="sourceLine" id="cb6-71" data-line-number="71"><span class="co">// +---------+-------+</span></a>
<a class="sourceLine" id="cb6-72" data-line-number="72"></a>
<a class="sourceLine" id="cb6-73" data-line-number="73"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-74" data-line-number="74"><span class="co">// * name addr sex</span></a>
<a class="sourceLine" id="cb6-75" data-line-number="75">spark.<span class="fu">read</span>.<span class="fu">option</span>(<span class="st">&quot;mergeSchema&quot;</span>, <span class="kw">true</span>).<span class="fu">parquet</span>(<span class="st">&quot;data{1,3}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-76" data-line-number="76"><span class="co">// +---------+-------+----+</span></a>
<a class="sourceLine" id="cb6-77" data-line-number="77"><span class="co">// |     name|   addr| sex|</span></a>
<a class="sourceLine" id="cb6-78" data-line-number="78"><span class="co">// +---------+-------+----+</span></a>
<a class="sourceLine" id="cb6-79" data-line-number="79"><span class="co">// |      sub|yangjae|male|</span></a>
<a class="sourceLine" id="cb6-80" data-line-number="80"><span class="co">// |yeonghoey| jamsil|null|</span></a>
<a class="sourceLine" id="cb6-81" data-line-number="81"><span class="co">// +---------+-------+----+</span></a>
<a class="sourceLine" id="cb6-82" data-line-number="82"></a>
<a class="sourceLine" id="cb6-83" data-line-number="83"><span class="co">//   name sex addr</span></a>
<a class="sourceLine" id="cb6-84" data-line-number="84"><span class="co">// + name addr sex</span></a>
<a class="sourceLine" id="cb6-85" data-line-number="85">spark.<span class="fu">read</span>.<span class="fu">parquet</span>(<span class="st">&quot;data{2,3}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-86" data-line-number="86"><span class="co">// +-----+----+-------+</span></a>
<a class="sourceLine" id="cb6-87" data-line-number="87"><span class="co">// | name| sex|   addr|</span></a>
<a class="sourceLine" id="cb6-88" data-line-number="88"><span class="co">// +-----+----+-------+</span></a>
<a class="sourceLine" id="cb6-89" data-line-number="89"><span class="co">// |cwkim|male| unjung|</span></a>
<a class="sourceLine" id="cb6-90" data-line-number="90"><span class="co">// |  sub|male|yangjae|</span></a>
<a class="sourceLine" id="cb6-91" data-line-number="91"><span class="co">// +-----+----+-------+</span></a>
<a class="sourceLine" id="cb6-92" data-line-number="92"></a>
<a class="sourceLine" id="cb6-93" data-line-number="93"><span class="co">//   name sex addr</span></a>
<a class="sourceLine" id="cb6-94" data-line-number="94"><span class="co">// * name addr sex</span></a>
<a class="sourceLine" id="cb6-95" data-line-number="95">spark.<span class="fu">read</span>.<span class="fu">option</span>(<span class="st">&quot;mergeSchema&quot;</span>, <span class="kw">true</span>).<span class="fu">parquet</span>(<span class="st">&quot;data{2,3}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-96" data-line-number="96"><span class="co">// +-----+----+-------+</span></a>
<a class="sourceLine" id="cb6-97" data-line-number="97"><span class="co">// | name| sex|   addr|</span></a>
<a class="sourceLine" id="cb6-98" data-line-number="98"><span class="co">// +-----+----+-------+</span></a>
<a class="sourceLine" id="cb6-99" data-line-number="99"><span class="co">// |cwkim|male| unjung|</span></a>
<a class="sourceLine" id="cb6-100" data-line-number="100"><span class="co">// |  sub|male|yangjae|</span></a>
<a class="sourceLine" id="cb6-101" data-line-number="101"><span class="co">// +-----+----+-------+</span></a>
<a class="sourceLine" id="cb6-102" data-line-number="102"></a>
<a class="sourceLine" id="cb6-103" data-line-number="103"><span class="co">//   name addr sex</span></a>
<a class="sourceLine" id="cb6-104" data-line-number="104"><span class="co">// + name sex</span></a>
<a class="sourceLine" id="cb6-105" data-line-number="105">spark.<span class="fu">read</span>.<span class="fu">parquet</span>(<span class="st">&quot;data{3,4}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-106" data-line-number="106"><span class="co">// +------+-------+----+</span></a>
<a class="sourceLine" id="cb6-107" data-line-number="107"><span class="co">// |  name|   addr| sex|</span></a>
<a class="sourceLine" id="cb6-108" data-line-number="108"><span class="co">// +------+-------+----+</span></a>
<a class="sourceLine" id="cb6-109" data-line-number="109"><span class="co">// |   sub|yangjae|male|</span></a>
<a class="sourceLine" id="cb6-110" data-line-number="110"><span class="co">// |suminb|   null|male|</span></a>
<a class="sourceLine" id="cb6-111" data-line-number="111"><span class="co">// +------+-------+----+</span></a>
<a class="sourceLine" id="cb6-112" data-line-number="112"></a>
<a class="sourceLine" id="cb6-113" data-line-number="113"><span class="co">//   name addr sex</span></a>
<a class="sourceLine" id="cb6-114" data-line-number="114"><span class="co">// * name sex</span></a>
<a class="sourceLine" id="cb6-115" data-line-number="115">spark.<span class="fu">read</span>.<span class="fu">option</span>(<span class="st">&quot;mergeSchema&quot;</span>, <span class="kw">true</span>).<span class="fu">parquet</span>(<span class="st">&quot;data{3,4}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-116" data-line-number="116"><span class="co">// +------+-------+----+</span></a>
<a class="sourceLine" id="cb6-117" data-line-number="117"><span class="co">// |  name|   addr| sex|</span></a>
<a class="sourceLine" id="cb6-118" data-line-number="118"><span class="co">// +------+-------+----+</span></a>
<a class="sourceLine" id="cb6-119" data-line-number="119"><span class="co">// |   sub|yangjae|male|</span></a>
<a class="sourceLine" id="cb6-120" data-line-number="120"><span class="co">// |suminb|   null|male|</span></a>
<a class="sourceLine" id="cb6-121" data-line-number="121"><span class="co">// +------+-------+----+</span></a>
<a class="sourceLine" id="cb6-122" data-line-number="122"></a>
<a class="sourceLine" id="cb6-123" data-line-number="123"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-124" data-line-number="124"><span class="co">// + name sex</span></a>
<a class="sourceLine" id="cb6-125" data-line-number="125">spark.<span class="fu">read</span>.<span class="fu">parquet</span>(<span class="st">&quot;data{1,4}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-126" data-line-number="126"><span class="co">// +---------+------+</span></a>
<a class="sourceLine" id="cb6-127" data-line-number="127"><span class="co">// |     name|  addr|</span></a>
<a class="sourceLine" id="cb6-128" data-line-number="128"><span class="co">// +---------+------+</span></a>
<a class="sourceLine" id="cb6-129" data-line-number="129"><span class="co">// |yeonghoey|jamsil|</span></a>
<a class="sourceLine" id="cb6-130" data-line-number="130"><span class="co">// |   suminb|  null|</span></a>
<a class="sourceLine" id="cb6-131" data-line-number="131"><span class="co">// +---------+------+</span></a>
<a class="sourceLine" id="cb6-132" data-line-number="132"></a>
<a class="sourceLine" id="cb6-133" data-line-number="133"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-134" data-line-number="134"><span class="co">// * name sex</span></a>
<a class="sourceLine" id="cb6-135" data-line-number="135">spark.<span class="fu">read</span>.<span class="fu">option</span>(<span class="st">&quot;mergeSchema&quot;</span>, <span class="kw">true</span>).<span class="fu">parquet</span>(<span class="st">&quot;data{1,4}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-136" data-line-number="136"><span class="co">// +---------+------+----+</span></a>
<a class="sourceLine" id="cb6-137" data-line-number="137"><span class="co">// |     name|  addr| sex|</span></a>
<a class="sourceLine" id="cb6-138" data-line-number="138"><span class="co">// +---------+------+----+</span></a>
<a class="sourceLine" id="cb6-139" data-line-number="139"><span class="co">// |yeonghoey|jamsil|null|</span></a>
<a class="sourceLine" id="cb6-140" data-line-number="140"><span class="co">// |   suminb|  null|male|</span></a>
<a class="sourceLine" id="cb6-141" data-line-number="141"><span class="co">// +---------+------+----+</span></a>
<a class="sourceLine" id="cb6-142" data-line-number="142"></a>
<a class="sourceLine" id="cb6-143" data-line-number="143"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-144" data-line-number="144"><span class="co">//   name sex addr</span></a>
<a class="sourceLine" id="cb6-145" data-line-number="145"><span class="co">//   name addr sex</span></a>
<a class="sourceLine" id="cb6-146" data-line-number="146"><span class="co">// + name sex</span></a>
<a class="sourceLine" id="cb6-147" data-line-number="147">spark.<span class="fu">read</span>.<span class="fu">parquet</span>(<span class="st">&quot;data{1,2,3,4}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-148" data-line-number="148"><span class="co">// +---------+-------+</span></a>
<a class="sourceLine" id="cb6-149" data-line-number="149"><span class="co">// |     name|   addr|</span></a>
<a class="sourceLine" id="cb6-150" data-line-number="150"><span class="co">// +---------+-------+</span></a>
<a class="sourceLine" id="cb6-151" data-line-number="151"><span class="co">// |    cwkim| unjung|</span></a>
<a class="sourceLine" id="cb6-152" data-line-number="152"><span class="co">// |      sub|yangjae|</span></a>
<a class="sourceLine" id="cb6-153" data-line-number="153"><span class="co">// |yeonghoey| jamsil|</span></a>
<a class="sourceLine" id="cb6-154" data-line-number="154"><span class="co">// |   suminb|   null|</span></a>
<a class="sourceLine" id="cb6-155" data-line-number="155"><span class="co">// +---------+-------+</span></a>
<a class="sourceLine" id="cb6-156" data-line-number="156"></a>
<a class="sourceLine" id="cb6-157" data-line-number="157"><span class="co">//   name addr</span></a>
<a class="sourceLine" id="cb6-158" data-line-number="158"><span class="co">//   name sex addr</span></a>
<a class="sourceLine" id="cb6-159" data-line-number="159"><span class="co">//   name addr sex</span></a>
<a class="sourceLine" id="cb6-160" data-line-number="160"><span class="co">// * name sex</span></a>
<a class="sourceLine" id="cb6-161" data-line-number="161">spark.<span class="fu">read</span>.<span class="fu">option</span>(<span class="st">&quot;mergeSchema&quot;</span>, <span class="kw">true</span>).<span class="fu">parquet</span>(<span class="st">&quot;data{1,2,3,4}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb6-162" data-line-number="162"><span class="co">// +---------+-------+----+</span></a>
<a class="sourceLine" id="cb6-163" data-line-number="163"><span class="co">// |     name|   addr| sex|</span></a>
<a class="sourceLine" id="cb6-164" data-line-number="164"><span class="co">// +---------+-------+----+</span></a>
<a class="sourceLine" id="cb6-165" data-line-number="165"><span class="co">// |    cwkim| unjung|male|</span></a>
<a class="sourceLine" id="cb6-166" data-line-number="166"><span class="co">// |      sub|yangjae|male|</span></a>
<a class="sourceLine" id="cb6-167" data-line-number="167"><span class="co">// |yeonghoey| jamsil|null|</span></a>
<a class="sourceLine" id="cb6-168" data-line-number="168"><span class="co">// |   suminb|   null|male|</span></a>
<a class="sourceLine" id="cb6-169" data-line-number="169"><span class="co">// +---------+-------+----+</span></a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">Row</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">types</span>._</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">import</span> spark.<span class="fu">implicits</span>._</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">val</span> schema1 = <span class="fu">StructType</span>(List(<span class="fu">StructField</span>(<span class="st">&quot;x&#39;&quot;</span>, StringType)))</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">val</span> data1   = List(<span class="fu">Row</span>(<span class="st">&quot;yeonghoey&quot;</span>))</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="kw">val</span> rdd1    = spark.<span class="fu">sparkContext</span>.<span class="fu">parallelize</span>(data1)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="kw">val</span> df1     = spark.<span class="fu">createDataFrame</span>(rdd1, schema1)</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">df1.<span class="fu">write</span>.<span class="fu">mode</span>(<span class="st">&quot;overwrite&quot;</span>).<span class="fu">parquet</span>(<span class="st">&quot;data1&quot;</span>)</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="kw">val</span> schema2 = <span class="fu">StructType</span>(List(<span class="fu">StructField</span>(<span class="st">&quot;x&#39;&quot;</span>, IntegerType)))</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="kw">val</span> data2   = List(<span class="fu">Row</span>(<span class="dv">31</span>))</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="kw">val</span> rdd2    = spark.<span class="fu">sparkContext</span>.<span class="fu">parallelize</span>(data2)</a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="kw">val</span> df2     = spark.<span class="fu">createDataFrame</span>(rdd2, schema2)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">df2.<span class="fu">write</span>.<span class="fu">mode</span>(<span class="st">&quot;overwrite&quot;</span>).<span class="fu">parquet</span>(<span class="st">&quot;data2&quot;</span>)</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">// ----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">spark.<span class="fu">read</span>.<span class="fu">parquet</span>(<span class="st">&quot;data{1,2}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">// Caused by: java.lang.UnsupportedOperationException: Unimplemented type: StringType</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"></a>
<a class="sourceLine" id="cb7-22" data-line-number="22">spark.<span class="fu">read</span>.<span class="fu">option</span>(<span class="st">&quot;mergeSchema&quot;</span>, <span class="kw">true</span>).<span class="fu">parquet</span>(<span class="st">&quot;data{1,2}&quot;</span>).<span class="fu">show</span>()</a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co">// Caused by: org.apache.spark.SparkException: Failed to merge incompatible data types StringType and IntegerType</span></a></code></pre></div>
<h1 id="how-to">How-to</h1>
<h1 id="links">Links</h1>
</body>
</html>
