#+TITLE: AWS

* Table of Contents :TOC_1_gh:
 - [[#resources][resources]]

* resources
** aws_elasticsearch_domain
- https://www.terraform.io/docs/providers/aws/r/elasticsearch_domain.html
- https://www.terraform.io/docs/providers/aws/r/elasticsearch_domain_policy.html

#+BEGIN_SRC terraform
  resource "aws_elasticsearch_domain" "main" {
    domain_name           = "my-domain"
    elasticsearch_version = "5.1"

    cluster_config {
      instance_type  = "m3.medium.elasticsearch"
      instance_count = 3
    }

    ebs_options {
      ebs_enabled = true
      volume_type = "gp2"
      volume_size = "30" # in GBs per data instance
    }
  }
#+END_SRC

** aws_elb
- https://www.terraform.io/docs/providers/aws/r/elb.html

#+BEGIN_SRC terraform
  resource "aws_elb" "endpoint" {
    name            = "my-elb"
    subnets         = ["${var.subnet_ids}"]
    security_groups = ["${var.security_groups}"]
    instances       = ["${aws_instance.cluster.*.id}"]

    internal = true

    listener {
      instance_port     = 8080
      instance_protocol = "http"
      lb_port           = 80
      lb_protocol       = "http"
    }

    health_check {
      target              = "HTTP:8080/"
      timeout             = 5
      interval            = 30
      unhealthy_threshold = 2
      healthy_threshold   = 10
    }

    tags {
      Cluster = "${var.cluster}"
    }
  }
#+END_SRC

** aws_iam_role
- https://www.terraform.io/docs/providers/aws/d/iam_role.html

#+BEGIN_SRC terraform
  resource "aws_iam_role" "main" {
    name = "${var.name}"

    assume_role_policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Service": "lambda.amazonaws.com"
          },
          "Action": "sts:AssumeRole"
        }
      ]
    }
    EOF
  }

  resource "aws_iam_role_policy" "kinesis" {
    name = "${aws_iam_role.main.name}-kinesis"
    role = "${aws_iam_role.main.id}"

    policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "kinesis:DescribeStream",
            "kinesis:GetRecords",
            "kinesis:GetShardIterator",
            "kinesis:ListStreams",
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
          ],
          "Resource": "${var.kinesis_arn}"
        }
      ]
    }
    EOF
  }

  resource "aws_iam_role_policy" "cloudwatch" {
    name = "${aws_iam_role.main.name}-cloudwatch"
    role = "${aws_iam_role.main.id}"

    policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
          ],
          "Resource": "*"
        }
      ]
    }
    EOF
  }

  # Needs a few seconds to replicate your new role through all regions.
  # SEE: http://stackoverflow.com/questions/37503075/invalidparametervalueexception-the-role-defined-for-the-function-cannot-be-assu
  resource "null_resource" "sleep" {
    triggers {
      role = "${aws_iam_role.main.arn}"
    }

    provisioner "local-exec" {
      command = "sleep 15"
    }
  }
#+END_SRC

** aws_lambda_function
- https://www.terraform.io/docs/providers/aws/r/lambda_function.html
- https://www.terraform.io/docs/providers/aws/r/lambda_event_source_mapping.html

#+BEGIN_SRC terraform
  data "archive_file" "code" {
    type        = "zip"
    source_file = "${path.module}/main.py"
    output_path = "${path.module}/lambda.zip"
  }

  resource "aws_lambda_function" "main" {
    function_name    = "lambda-kinesis"
    filename         = "${data.archive_file.code.output_path}"
    source_code_hash = "${data.archive_file.code.output_base64sha256}"
    handler          = "main.handle"
    runtime          = "python2.7"
    role             = "${var.role_arn}"
    memory_size      = 128
    timeout          = 10

    environment {
      variables {
        MY_ENV = "test"
      }
    }
  }

  resource "aws_lambda_event_source_mapping" "kinesis" {
    function_name     = "${aws_lambda_function.main.arn}"
    event_source_arn  = "${var.kinesis_arn}"
    batch_size        = 1000
    starting_position = "LATEST"
  }
#+END_SRC
