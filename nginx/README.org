#+TITLE: nginx

* Table of Contents :TOC_3_gh:
 - [[#beginners-guide][Beginner's Guide]]
   - [[#directives][Directives]]
 - [[#references][References]]
   - [[#core][core]]
     - [[#events][events]]
     - [[#include][include]]
     - [[#worker_processes][worker_processes]]
   - [[#http][http]]
     - [[#location][location]]
     - [[#types][types]]
   - [[#proxy][proxy]]
     - [[#proxy_redirect][proxy_redirect]]
   - [[#rewrite][rewrite]]
     - [[#rewrite-1][rewrite]]
 - [[#use-cases][Use Cases]]
   - [[#reverse-proxy-with-preserving-request-url][Reverse Proxy with preserving request URL]]
   - [[#nginx-boilerplate][nginx-boilerplate]]

* Beginner's Guide
- http://nginx.org/en/docs/beginners_guide.html

#+BEGIN_SRC shell
  $ nginx -s stop   # fast shutdown
  $ nginx -s quit   # graceful shutdown
  $ nginx -s reload # reloading the configuration file
  $ nginx -s reopen # reopening the log files
#+END_SRC

** Directives
- simple: ~name~ and ~parameters~, separated by ~spaces~, ends with ~;~
- block: Instead of the semicolon, it ends with a block surrounded by ~{}~
- A block surrounding directives is called a ~context~
- Top level context is called the ~main context~

* References
** core
- http://nginx.org/en/docs/ngx_core_module.html

*** events
- http://nginx.org/en/docs/ngx_core_module.html#events
- Where directives relating connection processing are placed

#+BEGIN_EXAMPLE
#+BEGIN_EXAMPLE
  events {
      use kqueue;
      worker_connections 2048;
  }
#+END_EXAMPLE

*** include
- http://nginx.org/en/docs/ngx_core_module.html#include
- Directives in files are inlcuded in the current context

#+BEGIN_EXAMPLE
  include mime.types;
  include vhosts/*.conf;
#+END_EXAMPLE
*** worker_processes
- http://nginx.org/en/docs/ngx_core_module.html#worker_processes
- Setting it to the number of available CPU cores would be a good start
- The value ~auto~ will try to autodetect it

#+BEGIN_EXAMPLE
  worker_processes auto;
#+END_EXAMPLE

** http
- http://nginx.org/en/docs/http/ngx_http_core_module.html

*** location
- http://nginx.org/en/docs/http/ngx_http_core_module.html#location

1. If there exists exact match(~=~) its configuration used
2. Pick the longest prefix match
3. Regex checked, in order of appearance
   1. first regex match configuration used
   2. no regex match, the longest prefix match used.

#+BEGIN_EXAMPLE
  location = / {
      [ configuration A ]
  }

  location / {
      [ configuration B ]
  }

  location /documents/ {
      [ configuration C ]
  }

  # '^~' modifier skips regex check
  location ^~ /images/ {
      [ configuration D ]
  }

  # '~*' modifier for regex case insensitive match
  # '~' for case sensitive
  location ~* \.(gif|jpg|jpeg)$ {
      [ configuration E ]
  }
#+END_EXAMPLE

#+BEGIN_EXAMPLE
  /                        -> A
  /index.html              -> B
  /documents/document.html -> C
  /images/1.gif            -> D
  /documents/1.jpg         -> E
#+END_EXAMPLE
*** types
- http://nginx.org/en/docs/http/ngx_http_core_module.html#types
- Maps file name extensions to MIME types of responses

#+BEGIN_EXAMPLE
  types {
      text/html  html;
      image/gif  gif;
      image/jpeg jpg;
  }
#+END_EXAMPLE

** proxy
*** proxy_redirect
- http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect
- Sets the text that should be changed in the ~Location~ and ~Refresh~ header fields of a proxied server response

** rewrite
- http://nginx.org/en/docs/http/ngx_http_rewrite_module.html

*** rewrite
- http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite
- https://serverfault.com/questions/379675/nginx-reverse-proxy-url-rewrite

#+BEGIN_EXAMPLE
  location  /foo {
    rewrite /foo(.*) /$1  break;
    proxy_pass         http://localhost:3200;
    proxy_redirect     off;
    proxy_set_header   Host $host;
  }
#+END_EXAMPLE

* Use Cases
** Reverse Proxy with preserving request URL
- https://www.nginx.com/resources/admin-guide/reverse-proxy/
- http://stackoverflow.com/questions/5834025/how-to-preserve-request-url-with-nginx-proxy-pass

#+BEGIN_EXAMPLE
  user www-data www-data;
  worker_processes auto;

  events {
  }

  http {
    server {
      listen 80;
      location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
      }
    }
  }
#+END_EXAMPLE

** nginx-boilerplate
- https://github.com/nginx-boilerplate/nginx-boilerplate
