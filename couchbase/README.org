#+TITLE: Couchbase

* Table of Contents :TOC_2_gh:
- [[#overview][Overview]]
- [[#reference][Reference]]
  - [[#internalsettings][internalSettings]]
- [[#terminology][Terminology]]
- [[#topics][Topics]]
  - [[#document-expiration][Document Expiration]]
- [[#how-to][How-to]]
- [[#links][Links]]
- [[#staging][Staging]]
  - [[#tunable-memory-and-ejection-policy][Tunable Memory and Ejection Policy]]
  - [[#2017-07-21-fri-couchbase-cli-group-add][<2017-07-21 Fri> couchbase-cli group-add]]
  - [[#2017-07-15-sat-couchbase-cli-flush][<2017-07-15 Sat> couchbase-cli flush]]
  - [[#2017-07-15-sat-cbbackupmgr][<2017-07-15 Sat> cbbackupmgr]]
  - [[#production][Production]]
  - [[#multi-dimensional-scalability][multi-dimensional-scalability]]
  - [[#sizing-guidelines][sizing guidelines]]
  - [[#querying-data-with-views][querying data with views]]
  - [[#graceful-failover][graceful failover]]

* Overview
* Reference
** internalSettings
- https://developer.couchbase.com/documentation/server/current/rest-api/rest-get-internal-setting.html

#+BEGIN_SRC shell
  $ curl -u Administrator:password -v http://localhost:8091/internalSettings
  {
    "indexAwareRebalanceDisabled": false,
    "rebalanceIndexWaitingDisabled": false,
    "rebalanceIndexPausingDisabled": false,
    "rebalanceIgnoreViewCompactions": false,
    "rebalanceMovesPerNode": 1,
    "rebalanceMovesBeforeCompaction": 64,
    "maxParallelIndexers": 4,
    "maxParallelReplicaIndexers": 2,
    "maxBucketCount": 10,
    "gotraceback": "crash",
    "indexAutoFailoverDisabled": true,
    "certUseSha1": false
  }
#+END_SRC

* Terminology
* Topics
** Document Expiration
- https://developer.couchbase.com/documentation/server/3.x/developer/dev-guide-3.0/doc-expiration.html
- https://developer.couchbase.com/documentation/server/3.x/admin/CLI/CBepctl/cbepctl-diskcleanup.html


- ~TTL~ in *seconds* if it's *30 days or less*
- ~TTL~ in *Unix time* if it's *over 30 days*
- Couchbase runs a process named ~expiry pager~ periodically to clean up expired items
- ~Expire pager~ runs every ~60~ minutes by default(can be configured through [[https://developer.couchbase.com/documentation/server/3.x/admin/CLI/CBepctl/cbepctl-diskcleanup.html][exp_pager_stime]])

* How-to
* Links
* Staging
** Tunable Memory and Ejection Policy
- https://developer.couchbase.com/documentation/server/4.6/architecture/db-engine-architecture.html#concept_b5n_bwn_vs__full-ejection

** TODO <2017-07-21 Fri> couchbase-cli group-add
./couchbase-cli group-manage -c localhost:8091 -u Administrator -p password --create --group-name=subnet-abcd1234
./couchbase-cli group-manage -c localhost:8091 -u Administrator -p password --from-group='Group 1' --to-group=subnet-abcd1234 --move-servers="10.42.42.10:8091"

** TODO <2017-07-15 Sat> couchbase-cli flush
/opt/couchbase/bin/couchbase-cli bucket-flush -c localhost:8091 -u Administrator -p password --bucket=default --force
curl -X POST -u Administrator:password http://10.42.42.10:8091/pools/default/buckets/default/controller/doFlush

** TODO <2017-07-15 Sat> cbbackupmgr
- cbbackupmgr config --archive /data/backup --repo cluster 
- cbbackupmgr list --archive /data/backup
- ./cbbackupmgr backup --archive /data/backup --repo default --host couchbase://10.42.42.10 --username Administrator --password password
- ./cbbackupmgr restore -a /data/backup -r cluster -c 10.42.131.69 -u Administrator -p password --start 2017-07-15T09_59_58.451600859Z --end 2017-07-15T09_59_58.451600859Z

** Production
- https://developer.couchbase.com/documentation/server/4.6/install/plan-for-production.html

** multi-dimensional-scalability
- https://www.couchbase.com/multi-dimensional-scalability-overview
- https://www.couchbase.com/binaries/content/assets/website/docs/datasheets/couchbase-multi-dimensional-scaling-isolate-and-optimize-query.pdf

** sizing guidelines
- https://developer.couchbase.com/documentation/server/current/install/sizing-general.html
- https://www.slideshare.net/Couchbase/sizing-your-couchbase-cluster-couchbase-connect-2015
- https://www.youtube.com/watch?v=kDZwjLW_GEo

** querying data with views
- https://developer.couchbase.com/documentation/server/4.6/architecture/querying-data-with-views.html


** graceful failover
- https://developer.couchbase.com/documentation/server/current/clustersetup/setup-failover-graceful.html
