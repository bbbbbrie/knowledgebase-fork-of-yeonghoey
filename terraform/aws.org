#+TITLE: AWS

* Table of Contents :TOC_1_gh:
 - [[#resources][resources]]

* resources
** aws_iam_role
- https://www.terraform.io/docs/providers/aws/d/iam_role.html

#+BEGIN_SRC terraform
  resource "aws_iam_role" "main" {
    name = "${var.name}"

    assume_role_policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Service": "lambda.amazonaws.com"
          },
          "Action": "sts:AssumeRole"
        }
      ]
    }
    EOF
  }

  resource "aws_iam_role_policy" "kinesis" {
    name = "${aws_iam_role.main.name}-kinesis"
    role = "${aws_iam_role.main.id}"

    policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "kinesis:DescribeStream",
            "kinesis:GetRecords",
            "kinesis:GetShardIterator",
            "kinesis:ListStreams",
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
          ],
          "Resource": "${var.kinesis_arn}"
        }
      ]
    }
    EOF
  }

  resource "aws_iam_role_policy" "cloudwatch" {
    name = "${aws_iam_role.main.name}-cloudwatch"
    role = "${aws_iam_role.main.id}"

    policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
          ],
          "Resource": "*"
        }
      ]
    }
    EOF
  }

  # Needs a few seconds to replicate your new role through all regions.
  # SEE: http://stackoverflow.com/questions/37503075/invalidparametervalueexception-the-role-defined-for-the-function-cannot-be-assu
  resource "null_resource" "sleep" {
    triggers {
      role = "${aws_iam_role.main.arn}"
    }

    provisioner "local-exec" {
      command = "sleep 15"
    }
  }
#+END_SRC
