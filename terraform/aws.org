#+TITLE: AWS

* Table of Contents :TOC_1_gh:
 - [[#resources][resources]]

* resources
** aws_lambda_function
#+BEGIN_SRC terraform
  data "archive_file" "code" {
    type        = "zip"
    source_file = "${path.module}/main.py"
    output_path = "${path.module}/lambda.zip"
  }

  resource "aws_lambda_function" "main" {
    function_name    = "lambda-kinesis"
    filename         = "${data.archive_file.code.output_path}"
    source_code_hash = "${data.archive_file.code.output_base64sha256}"
    handler          = "main.handle"
    runtime          = "python2.7"
    role             = "${var.role_arn}"
    memory_size      = 128
    timeout          = 10

    environment {
      variables {
        MY_ENV = "test"
      }
    }
  }

  resource "aws_lambda_event_source_mapping" "kinesis" {
    function_name     = "${aws_lambda_function.main.arn}"
    event_source_arn  = "${var.kinesis_arn}"
    batch_size        = 1000
    starting_position = "LATEST"
  }
#+END_SRC

** aws_iam_role
- https://www.terraform.io/docs/providers/aws/d/iam_role.html

#+BEGIN_SRC terraform
  resource "aws_iam_role" "main" {
    name = "${var.name}"

    assume_role_policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Service": "lambda.amazonaws.com"
          },
          "Action": "sts:AssumeRole"
        }
      ]
    }
    EOF
  }

  resource "aws_iam_role_policy" "kinesis" {
    name = "${aws_iam_role.main.name}-kinesis"
    role = "${aws_iam_role.main.id}"

    policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "kinesis:DescribeStream",
            "kinesis:GetRecords",
            "kinesis:GetShardIterator",
            "kinesis:ListStreams",
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
          ],
          "Resource": "${var.kinesis_arn}"
        }
      ]
    }
    EOF
  }

  resource "aws_iam_role_policy" "cloudwatch" {
    name = "${aws_iam_role.main.name}-cloudwatch"
    role = "${aws_iam_role.main.id}"

    policy = <<EOF
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
          ],
          "Resource": "*"
        }
      ]
    }
    EOF
  }

  # Needs a few seconds to replicate your new role through all regions.
  # SEE: http://stackoverflow.com/questions/37503075/invalidparametervalueexception-the-role-defined-for-the-function-cannot-be-assu
  resource "null_resource" "sleep" {
    triggers {
      role = "${aws_iam_role.main.arn}"
    }

    provisioner "local-exec" {
      command = "sleep 15"
    }
  }
#+END_SRC
